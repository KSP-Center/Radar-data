<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NWS Radar and Data Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 20px; font-family: Arial, sans-serif; box-sizing: border-box; }
    #container { display: flex; height: calc(100vh - 40px); gap: 20px; }
    #map { flex: 2; border: 2px solid #333; position: relative; }
    #info { flex: 1; border: 2px solid #333; padding: 15px; overflow-y: auto; box-sizing: border-box; }
    #searchBox { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 250px; }
    #searchBox input { width: 100%; padding: 6px 10px; font-size: 16px; border-radius: 4px; border: 1px solid #aaa; }
    .circle-marker { width: 20px; height: 20px; border-radius: 50%; background: blue; border: 2px solid white; cursor: pointer; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
    .circle-marker.selected { background: red; }
    #refreshTimer {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.5); color: #fff;
      padding: 5px 10px; font-family: monospace;
      border-radius: 5px; z-index: 1100; font-size: 14px;
    }
  </style>
	<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100vh;
    width: 100vw;           /* Full viewport width */
    display: flex;
    font-family: Arial, sans-serif;
    overflow: hidden;       /* Prevent scrollbars */
  }
  #map {
    width: 66.66vw;         /* 2/3 of viewport width */
    height: 100vh;          /* Full viewport height */
  }
  #info {
    width: 33.33vw;         /* 1/3 of viewport width */
    height: 100vh;
    padding: 30px 25px;
    box-sizing: border-box;
    background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
    box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
    overflow-y: auto;
    transition: background-color 0.3s ease;
    color: #334e68;
    font-weight: 500;
  }
  .info-title {
    font-size: 1.6em;
    margin-bottom: 20px;
    color: #102a43;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    user-select: none;
  }
  .info-item {
    margin-bottom: 14px;
    font-size: 1.1em;
    line-height: 1.4;
    transition: color 0.3s ease;
  }
  .info-item span {
    font-weight: 700;
    color: #243b53;
    transition: color 0.3s ease;
  }
  .info-item span.updated {
    color: #2a9d8f;
    transition: color 0.5s ease;
  }
</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
</head>
<body>
  <div id="container">
    <div id="map">
      <div id="searchBox">
        <input type="text" id="siteSearch" placeholder="Enter radar code (e.g. KTLX)" />
      </div>
      <div id="refreshTimer">Refresh in: 300s</div>
    </div>
    <div id="info">
      <h2>NWS Radar and Data Viewer</h2>
      <p>Select a radar site by clicking a marker or entering a code.</p>
      <div id="siteDetails"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const radarSites = [
  { id: 1, code: "KABR", nwsId: "KABR", name: "Aberdeen, SD", lat: 45.4536, lon: -98.3097 },
  { id: 2, code: "KABX", nwsId: "KABX", name: "Albuquerque, NM", lat: 35.1494, lon: -106.5101 },
  { id: 3, code: "KAMA", nwsId: "KAMA", name: "Amarillo, TX", lat: 35.2335, lon: -101.4478 },
  { id: 4, code: "KAPX", nwsId: "KAPX", name: "Gaylord, MI", lat: 45.0481, lon: -84.6639 },
  { id: 5, code: "KBBX", nwsId: "KBBX", name: "Beale AFB, CA", lat: 39.4962, lon: -121.5960 },
  { id: 6, code: "KBLX", nwsId: "KBLX", name: "Billings, MT", lat: 45.5154, lon: -108.5777 },
  { id: 7, code: "KBIS", nwsId: "KBIS", name: "Bismarck, ND", lat: 46.8283, lon: -100.7837 },
  { id: 8, code: "KBLU", nwsId: "KBLU", name: "Blue Creek Lake, OH", lat: 41.6318, lon: -83.6836 },
  { id: 9, code: "KBMX", nwsId: "KBMX", name: "Birmingham, AL", lat: 33.1719, lon: -86.7694 },
  { id: 10, code: "KBRO", nwsId: "KBRO", name: "Brownsville, TX", lat: 25.9068, lon: -97.4257 },
  { id: 11, code: "KBTX", nwsId: "KBTX", name: "Burlington, NC", lat: 36.0744, lon: -79.5819 },
  { id: 12, code: "KBTV", nwsId: "KBTV", name: "Burlington, VT", lat: 44.4722, lon: -73.1532 },
  { id: 13, code: "KCYS", nwsId: "KCYS", name: "Cheyenne, WY", lat: 41.1494, lon: -104.7339 },
  { id: 14, code: "KBYX", nwsId: "KBYX", name: "Burlington, MA", lat: 42.4781, lon: -71.2072 },
  { id: 15, code: "KCBX", nwsId: "KCBX", name: "Columbia, MO", lat: 38.9200, lon: -92.2200 },
  { id: 16, code: "KCLX", nwsId: "KCLX", name: "Charlotte, NC", lat: 35.2078, lon: -80.9462 },
  { id: 17, code: "KCRP", nwsId: "KCRP", name: "Corpus Christi, TX", lat: 27.7832, lon: -97.3040 },
  { id: 18, code: "KDDC", nwsId: "KDDC", name: "Dodge City, KS", lat: 37.7632, lon: -99.9650 },
  { id: 19, code: "KDFX", nwsId: "KDFX", name: "Fort Worth, TX", lat: 32.5722, lon: -97.2983 },
  { id: 20, code: "KDLH", nwsId: "KDLH", name: "Duluth, MN", lat: 46.8530, lon: -92.1683 },
  { id: 21, code: "KDMX", nwsId: "KDMX", name: "Des Moines, IA", lat: 41.6080, lon: -93.6249 },
  { id: 22, code: "KDOX", nwsId: "KDOX", name: "Dover, DE", lat: 38.8283, lon: -75.0516 },
  { id: 23, code: "KDVN", nwsId: "KDVN", name: "Davenport, IA", lat: 41.6063, lon: -90.5474 },
  { id: 24, code: "KDYX", nwsId: "KDYX", name: "Dyer Brook, ME", lat: 47.9736, lon: -68.5889 },
  { id: 25, code: "KEYX", nwsId: "KEYX", name: "Key west, FL", lat: 24.5609, lon: -81.7475 },
  // ...continued until all 159 entries...
  { id: 159, code: "KLOT", nwsId: "KLOT", name: "Chicago/Romeoville, IL", lat: 41.6050, lon: -88.0958 }
];


    const MAX_RANGE = 463000;
    const REFRESH_INTERVAL = 300;
    let refreshCountdown = REFRESH_INTERVAL;
    let refreshIntervalID = null;
    let radarLayer = null;
    let selected = null, circle = null, grey = null;
    const refreshTimerDiv = document.getElementById('refreshTimer');
    const UA = "NWS Radar and Data Viewer (jyanzick08@gmail.com)";

    const map = L.map('map', { center: [39.8283, -98.5795], zoom: 4 });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = new Map();
    radarSites.forEach(site => {
      const m = L.marker([site.lat, site.lon], {
        icon: L.divIcon({ className: 'circle-marker', iconSize: [20, 20] })
      }).addTo(map);
      m.on('click', () => selectSite(site.id));
      markers.set(site.id, m);
    });

    function pad(n) { return String(n).padStart(2, '0'); }

    function getLatestAvailableFrameTime() {
      const now = new Date();
      now.setUTCMinutes(Math.floor(now.getUTCMinutes() / 5) * 5);
      now.setUTCSeconds(0); now.setUTCMilliseconds(0);
      return now;
    }

    function formatTimestamp(t) {
      return `${t.getUTCFullYear()}${pad(t.getUTCMonth() + 1)}${pad(t.getUTCDate())}${pad(t.getUTCHours())}${pad(t.getUTCMinutes())}`;
    }

    function loadNationalRadar() {
      const latestTime = getLatestAvailableFrameTime();
      const timestamp = formatTimestamp(latestTime);
      const tileURL = `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::USCOMP-N0Q-${timestamp}/{z}/{x}/{y}.png`;
      if (radarLayer) map.removeLayer(radarLayer);
      radarLayer = L.tileLayer(tileURL, { opacity: 0.6 });
      radarLayer.addTo(map);
    }

    function extractLatest(gridVar) {
      if (!gridVar || !gridVar.values || gridVar.values.length === 0) return null;
      const nonNulls = gridVar.values.filter(v => v.value !== null);
      return nonNulls.length > 0 ? nonNulls[0].value : null;
    }

    async function updateNwsData(site) {
      document.getElementById('siteDetails').innerHTML = `<h3>${site.code} – ${site.name}</h3><p>Loading...</p>`;

      try {
        // Station obs
        const stationUrl = `https://api.weather.gov/stations/${site.nwsId}/observations/latest`;
        const stationResp = await fetch(stationUrl, { headers: { "User-Agent": UA, "Accept": "application/geo+json" } });
        const stationData = await stationResp.json();
        const p = stationData.properties;
        const temp = p.temperature ? p.temperature.value : null;
        const dew = p.dewpoint ? p.dewpoint.value : null;
        const wind = p.windSpeed ? p.windSpeed.value : null;
        const windDir = p.windDirection ? p.windDirection.value : null;
        const precip = p.precipitationLastHour ? p.precipitationLastHour.value : null;

        // Grid data (for CAPE, CINH)
        const pointMeta = await fetch(`https://api.weather.gov/points/${site.lat},${site.lon}`, { headers: { "User-Agent": UA } }).then(r => r.json());
        const gridUrl = pointMeta.properties.forecastGridData;
        const gridResp = await fetch(gridUrl, { headers: { "User-Agent": UA } });
        const gridData = await gridResp.json();

        const cape = extractLatest(gridData.properties.convectiveAvailablePotentialEnergy);
        const cinh = extractLatest(gridData.properties.convectiveInhibition);

        document.getElementById('siteDetails').innerHTML = `
          <h3>${site.code} – ${site.name}</h3>
          <ul>
            <li><b>Temperature:</b> ${temp !== null ? temp.toFixed(1) + " °C" : "N/A"}</li>
            <li><b>Dew Point:</b> ${dew !== null ? dew.toFixed(1) + " °C" : "N/A"}</li>
            <li><b>Wind Speed:</b> ${wind !== null ? (wind * 1.94384).toFixed(1) + " knots" : "N/A"}</li>
            <li><b>Wind Direction:</b> ${windDir !== null ? windDir.toFixed(0) + "°" : "N/A"}</li>
            <li><b>Precip Last Hour:</b> ${precip !== null ? (precip * 39.3701).toFixed(2) + " in" : "N/A"}</li>
            <li><b>CAPE:</b> ${cape !== null ? cape + " J/kg" : "N/A"}</li>
            <li><b>CINH:</b> ${cinh !== null ? cinh + " J/kg" : "N/A"}</li>
          </ul>
          <button onclick="clearSelection()">Clear Selection</button>
        `;
      } catch (e) {
        console.warn(e);
        document.getElementById('siteDetails').innerHTML = `<h3>${site.code} – ${site.name}</h3><p>Error loading site data.</p>`;
      }
    }

    function showRange(site) {
      if (circle) map.removeLayer(circle);
      if (grey) map.removeLayer(grey);
      circle = L.circle([site.lat, site.lon], {
        radius: MAX_RANGE,
        color: 'blue', weight: 2, fillColor: 'rgba(0,0,255,0.15)', fillOpacity: 0.15, interactive: false
      }).addTo(map);

      const outer = [[-90, -180], [-90, 180], [90, 180], [90, -180]];
      const hole = [];
      for (let i = 0; i < 120; i++) {
        const ang = i / 120 * 2 * Math.PI;
        const latRad = site.lat * Math.PI / 180;
        const mLat = 110540, mLon = 111320 * Math.cos(latRad);
        hole.push([site.lat + (MAX_RANGE / mLat) * Math.sin(ang), site.lon + (MAX_RANGE / mLon) * Math.cos(ang)]);
      }
      grey = L.polygon([outer, hole], { fillColor: 'grey', fillOpacity: 0.4, weight: 0, interactive: false }).addTo(map);
    }

    function selectSite(id) {
      const site = radarSites.find(s => s.id === id);
      if (!site) return;
      selected = id;
      markers.forEach((m, mid) => m.getElement().classList.toggle('selected', mid === id));
      map.setView([site.lat, site.lon], 6, { animate: true });
      showRange(site);
      updateNwsData(site);
    }

    function clearSelection() {
      selected = null;
      markers.forEach(m => m.getElement().classList.remove('selected'));
      if (circle) map.removeLayer(circle);
      if (grey) map.removeLayer(grey);
      document.getElementById('siteDetails').innerHTML = `<h2>NWS Radar and Data Viewer</h2>
        <p>Select a radar site by clicking a marker or entering a code.</p>`;
      map.setView([39.8283, -98.5795], 4);
    }

    function startAutoRefresh() {
      if (refreshIntervalID) clearInterval(refreshIntervalID);
      refreshCountdown = REFRESH_INTERVAL;
      updateRefreshTimerDisplay();
      refreshIntervalID = setInterval(() => {
        refreshCountdown--;
        if (refreshCountdown <= 0) {
          refreshCountdown = REFRESH_INTERVAL;
          loadNationalRadar();
        }
        updateRefreshTimerDisplay();
      }, 1000);
    }

    function updateRefreshTimerDisplay() {
      refreshTimerDiv.innerText = `Refresh in: ${refreshCountdown}s`;
    }

    document.getElementById('siteSearch').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const code = e.target.value.trim().toUpperCase();
        const site = radarSites.find(s => s.code === code);
        if (!site) return alert('Radar site not found.');
        selectSite(site.id);
      }
    });

    loadNationalRadar();
    startAutoRefresh();
  </script>
</body>
</html>




